(()=>{"use strict";const e=(e,t,...n)=>{const o=n[0];console.debug("Sending to "+e,{action:t,data:o}),"popup"==e||"background"==e||"sidepanel"==e?chrome.runtime.sendMessage({action:t,data:o?JSON.parse(JSON.stringify(o)):void 0,target:e}):chrome.tabs.query({active:!0,currentWindow:!0},(function(n){if(0===n.length||n[0]&&n[0].url&&(n[0].url.startsWith("chrome://")||n[0].url.startsWith("chrome-extension://")))return void chrome.tabs.create({url:"https://wenmoon.gg/extension",active:!0},(function(n){setTimeout((function a(){chrome.tabs.get(n.id,(function(i){chrome.runtime.lastError?console.debug("Error:",chrome.runtime.lastError):"complete"===i.status?chrome.tabs.sendMessage(n.id,{action:t,data:o?JSON.parse(JSON.stringify(o)):void 0,target:e}):setTimeout(a,100)}))}),500)}));const a=n[0];chrome.tabs.sendMessage(a.id,{action:t,data:o?JSON.parse(JSON.stringify(o)):void 0,target:e})}))};const t=function(e){const t=e=>{if(null===e||"object"!=typeof e)return e;if(e instanceof Map){const n=new Map;return e.forEach(((e,o)=>{n.set(o,t(e))})),n}if(Array.isArray(e))return e.map((e=>t(e)));const n={};return Object.keys(e).forEach((o=>{n[o]=t(e[o])})),n},n=()=>{try{const n={};Object.keys(e).forEach((o=>{const a=e[o];a instanceof Map||(n[o]=a instanceof Object?t(a):a)})),(e=>{const{isConnecting:t,isSigning:n,isWalletConnected:o,isPhantomAvailable:a,waitingToConnect:i,signHash:s,activeTabInfo:r,managedWindows:c,activeLayout:l}=e,d=function(e,t){var n={};for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&t.indexOf(o)<0&&(n[o]=e[o]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var a=0;for(o=Object.getOwnPropertySymbols(e);a<o.length;a++)t.indexOf(o[a])<0&&Object.prototype.propertyIsEnumerable.call(e,o[a])&&(n[o[a]]=e[o[a]])}return n}(e,["isConnecting","isSigning","isWalletConnected","isPhantomAvailable","waitingToConnect","signHash","activeTabInfo","managedWindows","activeLayout"]);chrome.storage.local.set({state:d},(()=>{console.debug("√âtat sauvegard√© dans le stockage")}))})(n)}catch(e){console.error("Error when saving state",e)}},o=(e,t=[])=>new Proxy(e,{get(e,n){const a=Reflect.get(e,n);return"object"!=typeof a||null===a||a instanceof Map?a:o(a,[...t,n])},set:(e,a,i)=>("object"!=typeof i||null===i||i instanceof Map?Reflect.set(e,a,i):Reflect.set(e,a,o(i,[...t,a])),n(),!0),deleteProperty:(e,t)=>(Reflect.has(e,t)&&(Reflect.deleteProperty(e,t),n()),!0)});return o(e)}({waitingToConnect:!1,isConnecting:!1,isSigning:!1,isPhantomAvailable:!1,isWalletConnected:!1,activeTabInfo:{id:null,isValid:!1,url:"",title:""},managedWindows:new Map}),n=new Map;chrome.webNavigation.onHistoryStateUpdated.addListener((e=>{0===e.frameId&&chrome.tabs.get(e.tabId,(t=>{chrome.runtime.lastError||t.active&&t.windowId===chrome.windows.WINDOW_ID_CURRENT&&s(e.tabId)}))})),chrome.webNavigation.onReferenceFragmentUpdated.addListener((e=>{0===e.frameId&&chrome.tabs.get(e.tabId,(t=>{chrome.runtime.lastError||t.active&&t.windowId===chrome.windows.WINDOW_ID_CURRENT&&s(e.tabId)}))})),chrome.webNavigation.onDOMContentLoaded.addListener((e=>{0===e.frameId&&chrome.tabs.get(e.tabId,(t=>{chrome.runtime.lastError||t.active&&t.windowId===chrome.windows.WINDOW_ID_CURRENT&&s(e.tabId)}))})),setInterval((()=>{chrome.tabs.query({active:!0,currentWindow:!0},(e=>{if(e.length>0&&void 0!==e[0].id){const t=e[0].id,o=n.get(t);o&&o.url===e[0].url||s(t)}}))}),1e3);let o=null;chrome.tabs.onActivated.addListener((function(e){o=e.windowId}));const a={initStatus:function({globalState:t}){return e("popup","solanaStatus",t),e("sidepanel","solanaStatus",t),e("popup","loginStatus",{isConnecting:!1,tokenJwt:t.tokenJwt}),e("sidepanel","loginStatus",{isConnecting:!1,tokenJwt:t.tokenJwt}),e("popup","currentUrl",t.activeTabInfo),Array.from(t.managedWindows.keys()).forEach((n=>{e("popup","windowStatusUpdate",{bookmarkId:t.managedWindows.get(n).bookmarkId,state:"OPENED"})})),t.activeLayout&&e("popup","currentActiveLayoutStatusUpdate",{layoutId:t.activeLayout.layout.id}),!1},connect:function({globalState:t}){return t.waitingToConnect=!0,e("content","connect"),!1},disconnect:function({globalState:t,message:n}){return t.isWalletConnected=!1,t.isPhantomAvailable=!1,t.publicKey=void 0,t.tokenJwt=void 0,t.challengeCode=void 0,t.signHash=void 0,t.isConnecting=!1,t.isSigning=!1,t.waitingToConnect=!1,e("popup","solanaStatus",t),e("sidepanel","solanaStatus",t),e("popup","loginStatus",{isConnecting:!1,tokenJwt:void 0}),e("sidepanel","loginStatus",{isConnecting:!1,tokenJwt:void 0}),!1},signResult:function({globalState:t,message:n}){return t.signHash=n.data.hash,t.isSigning=!1,t.isConnecting||fetch("https://api.wenmoon.gg/api/auth/verify?publicAddress="+t.publicKey+"&signature="+t.signHash+"&challenge="+t.challengeCode).then((e=>e.json())).then((n=>{t.isConnecting=!1,n.token?(t.tokenJwt=n.token,e("popup","loginStatus",{isConnecting:!1,tokenJwt:n.token}),e("sidepanel","loginStatus",{isConnecting:!1,tokenJwt:n.token})):(e("popup","loginStatus",{isConnecting:!1,error:n.message}),e("sidepanel","loginStatus",{isConnecting:!1,error:n.message}))})).catch((n=>{t.isConnecting=!1,e("popup","loginStatus",{isConnecting:!1,error:"Unable to contact remote server, please try again"}),e("sidepanel","loginStatus",{isConnecting:!1,error:"Unable to contact remote server, please try again"})})),!1},solanaStatus:function({globalState:t,message:n}){const o=n.data;return t.isPhantomAvailable=o.isPhantomAvailable,t.isWalletConnected=o.isWalletConnected,t.publicKey=o.publicKey,t.waitingToConnect&&t.publicKey?(t.waitingToConnect=!1,t.isSigning||(t.isSigning=!0,fetch("https://api.wenmoon.gg/api/token/challenge?publicAddress="+o.publicKey).then((e=>e.json())).then((n=>{t.challengeCode=n.code,e("content","signMessage",{message:n.code})})))):t.waitingToConnect=!1,e("popup","solanaStatus",t),e("sidepanel","solanaStatus",t),!1},forceConnect:function({globalState:t,message:n}){return t.tokenJwt=n.data.token,t.isPhantomAvailable=!0,t.isWalletConnected=!0,t.publicKey=n.data.user.address,e("popup","solanaStatus",t),e("sidepanel","solanaStatus",t),e("popup","loginStatus",{isConnecting:!1,tokenJwt:t.tokenJwt}),e("sidepanel","loginStatus",{isConnecting:!1,tokenJwt:t.tokenJwt}),chrome.action.getPopup({},(e=>{e||chrome.action.openPopup()})),!1},create_token:function({globalState:t,message:n}){const o=n.data;if(console.log("üöÄ Starting token creation process...",o),!t.publicKey)return e("sidepanel","create_token_result",{success:!1,error:"Wallet not connected"}),!1;const a={tokenLogo:o.tokenLogo||"",tokenName:o.tokenName,tokenSymbol:o.tokenSymbol,mint:o.mint,userWallet:o.userWallet,buyAmount:o.buyAmount,tokenDescription:o.tokenDescription||"",website:o.website||"",twitter:o.twitter||"",telegram:o.telegram||""};return console.log("üì§ Sending request to API with payload:",Object.assign(Object.assign({},a),{tokenLogo:a.tokenLogo?`${a.tokenLogo.substring(0,50)}...`:"empty"})),fetch("https://api.wenmoon.gg/api/tokens/create",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)}).then((e=>e.json())).then((t=>{return n=this,a=void 0,s=function*(){if(console.log("‚úÖ API response:",t),!t.success)return console.error("‚ùå API returned error:",t.error),void e("sidepanel","create_token_result",{success:!1,error:t.error||"Failed to create token"});const{poolTx:n}=t;console.log("üì¶ Received pool transaction from API"),e("sidepanel","create_token_result",{success:!0,poolTx:n,mint:o.mint})},new((i=void 0)||(i=Promise))((function(e,t){function o(e){try{c(s.next(e))}catch(e){t(e)}}function r(e){try{c(s.throw(e))}catch(e){t(e)}}function c(t){var n;t.done?e(t.value):(n=t.value,n instanceof i?n:new i((function(e){e(n)}))).then(o,r)}c((s=s.apply(n,a||[])).next())}));var n,a,i,s})).catch((t=>{console.error("‚ùå Token creation failed:",t),e("sidepanel","create_token_result",{success:!1,error:t.message||"Unknown error occurred"})})),!1},signTransaction:function({globalState:t,message:n}){return console.log("üì® Background received signTransaction:",n.data),chrome.tabs.query({active:!0,currentWindow:!0},(t=>{return o=this,a=void 0,s=function*(){const o=t[0];if(o&&o.id)try{function a(t){"signTransaction"===t.action&&"sidepanel"===t.target&&(chrome.runtime.onMessage.removeListener(a),e("sidepanel","signTransactionResult",t.data))}chrome.tabs.sendMessage(o.id,{action:"signTransaction",target:"content",transaction:n.data.transaction}),chrome.runtime.onMessage.addListener(a)}catch(i){e("sidepanel","signTransactionResult",{success:!1,error:String(i)})}else e("sidepanel","signTransactionResult",{success:!1,error:"No active tab found"})},new((i=void 0)||(i=Promise))((function(e,t){function n(e){try{c(s.next(e))}catch(e){t(e)}}function r(e){try{c(s.throw(e))}catch(e){t(e)}}function c(t){var o;t.done?e(t.value):(o=t.value,o instanceof i?o:new i((function(e){e(o)}))).then(n,r)}c((s=s.apply(o,a||[])).next())}));var o,a,i,s})),!0},signTransactionResult:function({globalState:t,message:n}){return console.log("üì® Background received signTransactionResult:",n.data),e("sidepanel","signTransactionResult",{success:n.data.success,signature:n.data.signature,error:n.data.error}),!1},confirmTransaction:function({globalState:t,message:n}){console.log("üì® Background received confirmTransaction:",n.data);const{signedTransaction:o}=n.data;if(!o||"string"!=typeof o)return console.error("‚ùå Invalid signed transaction format"),e("sidepanel","confirmTransactionResult",{success:!1,error:"Invalid signed transaction format"}),!0;const a=o;return fetch("https://api.wenmoon.gg/api/transactions/send",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({signedTransaction:a})}).then((e=>e.json())).then((t=>{console.log("‚úÖ Backend transaction result:",t),t.success?e("sidepanel","confirmTransactionResult",{success:!0,signature:t.signature}):e("sidepanel","confirmTransactionResult",{success:!1,error:t.error||"Failed to send transaction"})})).catch((t=>{console.error("‚ùå Error sending transaction to backend:",t),e("sidepanel","confirmTransactionResult",{success:!1,error:t.message||"Failed to send transaction"})})),!0}};let i=new Promise((n=>{chrome.storage.local.get((o=>{const a=o.state||{waitingToConnect:!1,isConnecting:!1,isSigning:!1,isPhantomAvailable:!1};Object.keys(a).forEach((e=>{const n=e;t[n]=a[n]})),t.tokenJwt?fetch("https://api.wenmoon.gg/api/me",{headers:{Authorization:"Bearer "+t.tokenJwt}}).then((e=>e.json())).then((o=>{o.error?(console.debug("User disconnected"),t.tokenJwt=void 0,e("popup","loginStatus",{isConnecting:!1,tokenJwt:o.token})):e("popup","loginStatus",{isConnecting:!1}),n(t)})).catch((e=>{console.debug(e),n(t)})):n(t)}))}));function s(o){chrome.tabs.get(o,(a=>{if(chrome.runtime.lastError)return console.warn("Error:",chrome.runtime.lastError),void(t.activeTabInfo.isValid=!1);if(t.activeWindowId=a.windowId,t.managedWindows.has(a.windowId))return;const i=n.get(o);(!i||i.url!==a.url||i.title!==a.title)&&(t.activeTabInfo.id=a.id,t.activeTabInfo.url=a.url||"",t.activeTabInfo.title=a.title||"",t.activeTabInfo.isValid=!0,e("popup","currentUrl",t.activeTabInfo),n.set(o,{url:a.url,title:a.title,lastUpdated:Date.now()}))}))}!function(){var n,s,r,c;n=this,s=void 0,c=function*(){var n;yield i,e("popup","solanaStatus",n=t),e("popup","loginStatus",n),chrome.runtime.onConnect.addListener((e=>{"popup"==e.name&&e.onDisconnect.addListener((()=>{n.isConnecting=!1,n.isSigning=!1,n.waitingToConnect=!1}))})),chrome.runtime.onMessage.addListener(((e,t,i)=>{var s;if(console.log("üì® Background received message:",e),"background"==e.target&&"action"in e)if(console.log("üîß Processing background message:",e.action),Object.keys(a).includes(e.action)){const t={message:e,globalState:n,sendResponse:i};a[e.action](t)}else console.log("‚ùå No handler found for action:",e.action);if("open_side_panel"===e.action){const n=(null===(s=t.tab)||void 0===s?void 0:s.windowId)||o||chrome.windows.WINDOW_ID_CURRENT;try{if(void 0===chrome.sidePanel)return i({success:!1,error:"SidePanel API not available"}),!0;chrome.sidePanel.open({windowId:n}),chrome.runtime.sendMessage({target:"sidepanel",action:"open_side_panel",tweetData:e.tweetData}),setTimeout((()=>{chrome.runtime.sendMessage({target:"sidepanel",action:"open_side_panel",tweetData:e.tweetData})}),100),i({success:!0})}catch(e){i({success:!1,error:e.message})}return!0}}))},new((r=void 0)||(r=Promise))((function(e,t){function o(e){try{i(c.next(e))}catch(e){t(e)}}function a(e){try{i(c.throw(e))}catch(e){t(e)}}function i(t){var n;t.done?e(t.value):(n=t.value,n instanceof r?n:new r((function(e){e(n)}))).then(o,a)}i((c=c.apply(n,s||[])).next())}))}(),chrome.runtime.onStartup.addListener((()=>{console.debug("onStartup()")})),chrome.runtime.onInstalled.addListener((()=>{console.log("Token Launcher extension installed")})),chrome.tabs.onActivated.addListener((n=>{void 0!==n.tabId?s(n.tabId):(t.activeTabInfo.isValid=!1,t.activeTabInfo.id=null,t.activeTabInfo.url="",t.activeTabInfo.title="",e("popup","currentUrl",t.activeTabInfo))})),chrome.tabs.onUpdated.addListener(((n,o,a)=>{if(a.active&&a.windowId===chrome.windows.WINDOW_ID_CURRENT&&void 0!==n){if(t.managedWindows.has(a.windowId))return;t.activeTabInfo.id=n,t.activeTabInfo.isValid=!0;let i=!1;if(void 0!==o.url&&(t.activeTabInfo.url=o.url,i=!0),void 0!==o.title&&(t.activeTabInfo.title=o.title,i=!0),"complete"===o.status)return void setTimeout((()=>s(n)),100);i&&e("popup","currentUrl",t.activeTabInfo)}})),chrome.webNavigation.onCompleted.addListener((e=>{0===e.frameId&&chrome.tabs.get(e.tabId,(t=>{chrome.runtime.lastError||t.active&&t.windowId===chrome.windows.WINDOW_ID_CURRENT&&setTimeout((()=>s(e.tabId)),200)}))})),chrome.tabs.query({active:!0,currentWindow:!0},(e=>{e.length>0&&void 0!==e[0].id?s(e[0].id):t.activeTabInfo.isValid=!1}))})();